<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ParseRdf Worker E2E Test Page</title>
  </head>
  <body>
    <h1>ParseRdf Worker E2E Test Page</h1>
    <pre id="status">starting</pre>
    <script type="module">
      // This page is intended to be served by the Vite dev server (http://localhost:8080/)
      // It will create a module worker referencing the source worker file so vite's worker
      // bundling and configured polyfills take effect.
      (async () => {
        const statusEl = document.getElementById('status');
        function setStatus(s) { if (statusEl) statusEl.textContent = s; }

        // Create the worker using the same path as in the app
        const worker = new Worker('/src/workers/parseRdf.worker.ts', { type: 'module' });

        const id = 'pw-e2e-1';
        let quads = [];

        worker.addEventListener('message', (ev) => {
          const msg = ev && ev.data ? ev.data : {};
          if (!msg || msg.id !== id) return;

          if (msg.type === 'start') {
            setStatus('started: ' + String(msg.contentType || 'unknown'));
          } else if (msg.type === 'quads' && Array.isArray(msg.quads)) {
            quads.push(...msg.quads);
            setStatus('received quads: ' + quads.length);
          } else if (msg.type === 'end') {
            setStatus('end: quads=' + quads.length);
            // Expose result for Playwright to inspect
            window.__VG_E2E_RESULT = { quads, ok: quads.length > 0 };
            // also append to DOM for easier debugging
            const out = document.createElement('pre');
            out.id = 'result';
            out.textContent = JSON.stringify({ quadsCount: quads.length, quads }, null, 2);
            document.body.appendChild(out);
          } else if (msg.type === 'error') {
            setStatus('error: ' + String(msg.message || ''));
            window.__VG_E2E_RESULT = { error: String(msg.message || '') };
            const out = document.createElement('pre');
            out.id = 'result';
            out.textContent = 'ERROR: ' + JSON.stringify(msg);
            document.body.appendChild(out);
          }
        });

        // Small Turtle snippet (same as unit test)
        const ttl = `
@prefix ex: <http://example.org/> .
ex:a ex:knows "Alice" .
`.trim();

        // Use a data: URL to avoid external network
        const dataUrl = 'data:text/turtle;charset=utf-8,' + encodeURIComponent(ttl);

        // Kick off parse
        setStatus('posting parse request');
        worker.postMessage({ type: 'parseUrl', id, url: dataUrl });
      })();
    </script>
  </body>
</html>
